# Middlewares

### üß© ¬øQu√© es un Middleware?

Un **middleware** es una capa intermedia que se ejecuta **antes o despu√©s** de que una petici√≥n HTTP llegue al controlador.

Sirve para:

- Filtrar o modificar peticiones y respuestas.
- Proteger rutas (por ejemplo, comprobar autenticaci√≥n o permisos).
- Registrar logs, medir tiempos o modificar cabeceras.
- Ejecutar tareas despu√©s de la respuesta (`terminate()`).

---

### üß± Estructura b√°sica de un Middleware

Se ubican en:

```php
app/Http/Middleware/
```

Ejemplo de middleware simple:

```php
namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class CheckEdad
{
    public function handle(Request $request, Closure $next)
    {
        if ($request->edad < 18) {
            return response('Acceso denegado.', 403);
        }

        return $next($request); // contin√∫a hacia la siguiente capa
    }
}
```

---

### ‚öôÔ∏è Creaci√≥n de un Middleware

Comando Artisan:

```php
php artisan make:middleware CheckEdad
```

Esto crea el archivo en `app/Http/Middleware/`.

---

### ü™Ñ Registro de Middleware (Laravel 12)

> üö® Importante: En Laravel 12 ya no se usa Http\Kernel.php.
> 
> 
> Ahora se registran en **`bootstrap/app.php`**, usando `withMiddleware()`.
> 

Ejemplo:

```php
use Illuminate\Foundation\Configuration\Middleware;
use App\Http\Middleware\CheckEdad;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
    )
    ->withMiddleware(function (Middleware $middleware) {
        // Middleware global
        $middleware->append(CheckEdad::class);

        // Alias para usar en rutas
        $middleware->alias([
            'edad' => CheckEdad::class,
        ]);

        // Agregar a grupo web
        $middleware->appendToGroup('web', [
            CheckEdad::class,
        ]);
    })
    ->create();

```

**üõ£Ô∏è Uso en rutas**

```php
use App\Http\Middleware\CheckEdad;

Route::get('/zona', function () {
    return 'Bienvenido a la zona restringida';
})->middleware('edad');

// O directamente con la clase
Route::get('/admin', function () {
    return 'Panel de admin';
})->middleware(CheckEdad::class);
```

---

### üß∞ Tipos de Middleware

1. **Globales**
    
    Se ejecutan en **todas** las peticiones.
    
    Ejemplo: logs, CORS, mantenimiento, etc.
    
2. **De Ruta**
    
    Se asignan manualmente en rutas o grupos.
    
3. **De Grupo**
    
    Laravel tiene grupos predefinidos:
    
    - `web`: para rutas normales con sesi√≥n, CSRF, etc.
    - `api`: para rutas sin estado (token, JSON).

### üîê Middleware Integrados de Laravel

Algunos comunes:

- `\Illuminate\Auth\Middleware\Authenticate::class` ‚Üí controla acceso autenticado.
- `\Illuminate\Foundation\Http\Middleware\VerifyCsrfToken::class` ‚Üí protecci√≥n CSRF.
- `\Illuminate\Routing\Middleware\SubstituteBindings::class` ‚Üí inyecci√≥n de modelos.
- `\Illuminate\Routing\Middleware\ThrottleRequests::class` ‚Üí l√≠mite de peticiones.

---

### üí° Buenas pr√°cticas

‚úÖ Usa alias para que las rutas sean m√°s legibles.

‚úÖ Crea middleware peque√±os y espec√≠ficos (responsabilidad √∫nica).

‚úÖ Evita l√≥gica de negocio compleja dentro del middleware.

‚úÖ Usa terminables para tareas postrespuesta (logs, m√©tricas, etc.).

‚úÖ Revisa el orden: el que se **pretenda** se ejecuta antes que los dem√°s.

## **Agrupar rutas con Prefix + Middleware en Laravel 12**

---

### üß© ¬øPara qu√© sirve?

Agrupar rutas con `prefix()` y `middleware()` te permite:

- Reutilizar configuraci√≥n com√∫n (prefijo, middleware, namespace).
- Organizar tus rutas de forma limpia.
- Controlar acceso a secciones (por ejemplo, panel de admin, API, etc.).

---

### üß± Sintaxis b√°sica

```php
use Illuminate\Support\Facades\Route;
use App\Http\Middleware\CheckEdad;

Route::prefix('admin') // üëâ todas las rutas tendr√°n /admin
    ->middleware(['edad', 'auth']) // üëâ todos estos middleware aplican
    ->group(function () {

        Route::get('/dashboard', function () {
            return 'Panel de administraci√≥n';
        });

        Route::get('/usuarios', function () {
            return 'Lista de usuarios';
        });
    });
```

‚úÖ Resultado:

- `/admin/dashboard`
- `/admin/usuarios`
    
    Ambas rutas pasan por los middleware `edad` y `auth`.
    

---

### ü™Ñ Middleware en alias o clase

Puedes usar **alias** (si los registraste en `bootstrap/app.php`):

```php
->middleware(['edad', 'auth'])
```

O directamente **por clase**:

```php
use App\Http\Middleware\CheckEdad;
use App\Http\Middleware\Authenticate;

->middleware([CheckEdad::class, Authenticate::class])
```

## **‚öôÔ∏è Ejemplo completo ‚Äì Laravel 12 con `bootstrap/app.php`**

Middleware 1:

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class mid1
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        if (1==2) {
            return response()->json([
                "mensaje"=>"Acceso denegado por mid1"

            ], 401);
        }
        return $next($request);
    }
}
```

Middleware 2:

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class mid2
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        if (1==2) {
            return response()->json([
                "mensaje"=>"Acceso denegado por mid2"
            ],401);
        }
        return $next($request);
    }
}
```

Rutas:

```php
Route::get('users', [ControladorUsuarios::class, 'getUsers'])->middleware('mid1','mid2');
Route::get('user/{id}', [ControladorUsuarios::class, 'getUser']);
Route::post('user', [ControladorUsuarios::class, 'postUser']);

Route::prefix('admin') //todas las rutas tendr√°n /admin
    ->middleware(['mid1', 'mid2']) //todos estos middleware aplican
    ->group(function () {
        Route::get('/user/{id}', [ControladorUsuarios::class, 'getUser']);
        Route::post('user', [ControladorUsuarios::class, 'postUser']);
    });

```

Registro de alias de los middlewares bootstrap/app.php

```php
<?php

use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware): void {
        //
        //Para agregar un alias (para usarlo en rutas)
        $middleware->alias([
            'mid1' => \App\Http\Middleware\mid1::class,
            'mid2' => \App\Http\Middleware\mid2::class,
        ]);
    })
    ->withExceptions(function (Exceptions $exceptions): void {
        //
    })->create();

```

Controlador:

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class ControladorUsuarios extends Controller
{
    function getUser($id){
        return response()->json([
            "funci√≥n"=>"Aceddiendo a getUser",
            "id"=>$id
        ]);
    }

     function getUsers(){
        return response()->json([
            "funci√≥n"=>"Aceddiendo a getUser"]);
    }

    function postUser(Request $request){
        return response()->json([
            "funci√≥n"=>"Aceddiendo a postUser",
            "nombre"=>$request->input("nombre"),
            "email"=>$request->input("email")
        ]);
    }
}
```